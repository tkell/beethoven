<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>What We Talk About When We Talk About Beethoven</title>

    <!-- <link href="css/main.css" rel="stylesheet"> -->
</head>

<body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src='remix.js'></script>

<script type="text/javascript">
// Helpers
function trim(str) {
    return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
}

function getMax(theArray) {
    return Math.max.apply( Math, theArray );
}

function getRandomElement(theArray) {
    return theArray[Math.floor(Math.random() * theArray.length)];
}

function intsToNotes(the_int){
    return {'0': 'c', '1': 'c#', '2': 'd', '3': 'eb', '4': 'e', '5': 'f', '6': 'f#', '7': 'g', '8': 'ab', '9': 'a', '10': 'bb', '11': 'b'}[the_int];

    } 

function notesToInts(the_note) {
    return {'c': '0', 'c#': '1', 'd': '2', 'eb': '3', 'e': '4', 'f': '5', 'f#': '6', 'g': '7', 'ab': '8', 'a': '9', 'bb': '10', 'b': '11',}[the_note]
}


function info(str) {
    $("#info").text(str);
}


// the md5 is 1ce90444c07f989f2b2b09d97cc87d43 for the record
var apiKey = 'WOUHTN44BMS5SMPF2';
var trackID = 'TRKXYVL13F72A49B87';
var trackURL = 'audio/beethoven_7_I.mp3'

var convolutionURLs = ['audio/convolve-delay_I.mp3']


var remixer;
var player;
var filteredPlayer;
var track;

var organizedSegments = {};
var startingText = "...what do you think of the Seventh Symphony?";
var easterEggs = ['roll over']; // not done yet.

var currentMovement = 0;
var mappings = [{}, {}, {}, {}];
var mappingIndexes = [0, 0, 0, 0];

// First movement form
// var introduction = 0, 240];
// var exposition = [241, 512];
// var development = [513, 634];
// var recap = [635, 773];
// var coda = [774, 855];

function parseInput(theString) {
    letters = theString.split('');
    words = theString.split(' ');
    words = theString.split(' ');

    // We'll parse movement & form jumps here, eventually

    // Assign any new words
    var playback = [];
    for (var i = 0; i < words.length; i++) {
        var word = words[i].toLowerCase();
      if (mappings[currentMovement].hasOwnProperty(word) == false) {
          var numberOfBeats = parseInt((word.length / 3) + 1);
          var index = mappingIndexes[currentMovement];
          mappings[currentMovement][word] = track.analysis.beats.slice(index, index + numberOfBeats);
          mappingIndexes[currentMovement] = mappingIndexes[currentMovement] + numberOfBeats;
        }
        playback = playback.concat(mappings[currentMovement][word]);
    }

    // Play things!  in sequence for now...
    player.play(0, playback);
}

$(document).ready(function(){
    $("#textarea-input").val(startingText);

    // load things into remix
    var context = new webkitAudioContext();
    remixer = createJRemixer(context, $, apiKey);

    // Create the filter
    var filter = context.createBiquadFilter();
    filter.type = 0; // Low-pass filter. 
    filter.frequency.value = 1760; 

    // Load the convolver - might still keep this, but with a much smaller chunk of time
    var convolver = context.createConvolver();
    var request = new XMLHttpRequest();
    request.open("GET", convolutionURLs[0], true);
    request.responseType = "arraybuffer";
    request.onload = function () {
      info("Convolver loaded...");
      convolver.buffer = context.createBuffer(request.response, false);
    }
    request.send();

    // Add a gain to keep things backgrounded.
    var filterGain = context.createGainNode();
    filterGain.gain.value = 0.35;

    player = remixer.getPlayer();
    filteredPlayer = remixer.getPlayer([convolver, filter, filterGain]);
    info("Loading analysis data...");

    // Set up our arrays here...
    for (var i = 0; i < 12; i++ ) {
        organizedSegments[intsToNotes(i)] = [];
    }

    remixer.remixTrackById(trackID, trackURL, function(t, percent) {
        track = t;

        info(percent + "% of the track loaded...");
        if (track.status == 'ok') {
            // Organize each segment by max chroma
            var chromaFloats = [];
            for (var i = 0; i < track.analysis.segments.length; i++ ) {
                chromaFloats = []
                for (var j = 0; j < track.analysis.segments[i].pitches.length; j++) {
                    chromaFloats.push(parseFloat(track.analysis.segments[i].pitches[j]))
                }
                var maxVal = getMax(chromaFloats);
                var note = intsToNotes(chromaFloats.indexOf(maxVal))
                organizedSegments[note].push(track.analysis.segments[i]);
            }
            info('Ready!');
        }
        
    });

    // Take user input, update the UI, and parse the input
    $("#textarea-input").keyup(function(e) {
        if (e.which == 13) {
            var theString = $("#textarea-input").val();
            theString = trim(theString);

            var currentText = $('#text-log').html();
            var textArray = currentText.split('<br>');
            if (textArray.length > 10) {
                 textArray.shift();   
            }

            currentText = ''
            for (var i = 0; i < textArray.length; i++) {
                currentText = currentText + textArray[i] + '<br>';
            }

            var newHtml = currentText + theString
            $('#text-log').html(newHtml);
            $("#textarea-input").val("");

            parseInput(theString);
        }
      else if (e.which >= 65 && e.which  <= 76) {
          var theNote = String.fromCharCode(e.which).toLowerCase();
          switch(theNote) {
                  case 'h':
                    theNote = 'bb'
                    break;
                  case 'i':
                    theNote = 'eb'
                    break;
                  case 'j':
                    theNote = 'f#'
                    break;
                  case 'k':
                    theNote = 'c#'
                    break;
                  case 'l':
                    theNote = 'ab'
                    break;
                  default:
                    theNote = theNote;
                    break;
              }
          filteredPlayer.play(0, getRandomElement(organizedSegments[theNote]));
        }
    });
}); // end init

</script>

<div id="title">
     <h2>What We Talk About When We Talk About Beethoven</h2>
</div>

<div id="splash-image">
    <img src="splash.jpg">
</div>


<div id="text-log">
</div>

<div id="text-input">
    <textarea id="textarea-input" rows="7" cols="60">
    </textarea>
</div>

<div id="buttons">
</div>

<div id="about">
<p> What We Talk About When We Talk About Beethoven is a piece for human and human, or human and chatbot.</p>
<p> WWTAWWTAB works best in Chrome.</p>
</div>

<div id="info">
</div>

</body>

</html>