<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>What We Talk About When We Talk About Beethoven</title>

    <!-- <link href="css/main.css" rel="stylesheet"> -->
</head>

<body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src='remix.js'></script>
<script type="text/javascript" src='buffer-loader.js'></script>

<script type="text/javascript">
// Helpers
function trim(str) {
    return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
}

function getMax(theArray) {
    return Math.max.apply( Math, theArray );
}

function getRandomElement(theArray) {
    return theArray[Math.floor(Math.random() * theArray.length)];
}

function intsToNotes(the_int){
    return {'0': 'c', '1': 'c#', '2': 'd', '3': 'eb', '4': 'e', '5': 'f', '6': 'f#', '7': 'g', '8': 'ab', '9': 'a', '10': 'bb', '11': 'b'}[the_int];

    } 

function notesToInts(the_note) {
    return {'c': '0', 'c#': '1', 'd': '2', 'eb': '3', 'e': '4', 'f': '5', 'f#': '6', 'g': '7', 'ab': '8', 'a': '9', 'bb': '10', 'b': '11',}[the_note]
}


function info(str) {
    $("#info").text(str);
}

var apiKey = 'WOUHTN44BMS5SMPF2';
var trackIDs = ['TRKXYVL13F72A49B87', 'TRMAPVN1408A307A04', 'TRBVPWY1408A33440C', 'TRVTOJT1408A35EDFA'];
var trackURLs = ['audio/beethoven_7_I.mp3', 'audio/beethoven_7_II.mp3', 'audio/beethoven_7_III.mp3', 'audio/beethoven_7_IV.mp3']

var convolver;
var convolutionURLs = ['audio/convolve_I.mp3', 'audio/convolve_II.mp3', 'audio/convolve_III.mp3', 'audio/convolve_IV.mp3'];
var convolutionBuffers = [];


var remixer;
var player;
var filteredPlayer;
var tracks = [null, null, null, null];

var organizedSegments = [{}, {}, {}, {}];
var startingText = "...what do you think of the Seventh Symphony?";
var easterEggs = ['roll over']; // not done yet, may never be.

var currentMovement = 0;
var mappings = [{}, {}, {}, {}];
var mappingIndexes = [0, 0, 0, 0];
var formWords = [{}, {}, {}, {}];


function parseInput(theString) {
    letters = theString.split('');
    words = theString.split(' ');

    // we many want to strip punctuation here too
    for (var i = 0; i < words.length; i++) {
        words[i] = words[i].toLowerCase();
    }
     // Move the 'play head' based on the word before or after 'movement'
    if (words.indexOf('movement') != -1) {
        var before = '';
        var after = '';
        if (words.indexOf('movement') > 0) {before = words[words.indexOf('movement') - 1];}
        if (words.indexOf('movement') < words.length - 1) {after = words[words.indexOf('movement') + 1]};

        if (before == 'first' || before == '1st' || after == 'i' || after == '1' || after == 'one') {
          currentMovement = 0;
        }
        else if (before == 'second' || before == '2nd' || after == 'ii' || after == '2' || after == 'two') {
          currentMovement = 1;
        }
        else if (before == 'third' || before == '3rd' || after == 'iii' || after == '3' || after == 'three') {
          currentMovement = 2;
        }
        else if (before == 'fourth' || before == 'last' ||before == '4th' || after == 'iv' || after == '4' || after == 'four') {
          currentMovement = 3;
        }
        else if (before == 'previous' && currentMovement != 0) {
          currentMovement = currentMovement - 1;
        }
        else if (before == 'next' && currentMovement != 3) {
          currentMovement = currentMovement + 1;
        }
    }
    // and then things about the form of each movement can go here


    // Assign any new words
    var playback = [];
    for (var i = 0; i < words.length; i++) {
        var word = words[i].toLowerCase();
      if (mappings[currentMovement].hasOwnProperty(word) == false) {
          var numberOfBeats = parseInt((word.length / 3) + 1);
          var index = mappingIndexes[currentMovement];
          //replace with tracks[currentMovement].analysis.etc...
          mappings[currentMovement][word] = tracks[currentMovement].analysis.beats.slice(index, index + numberOfBeats);
          mappingIndexes[currentMovement] = mappingIndexes[currentMovement] + numberOfBeats;
        }
        playback = playback.concat(mappings[currentMovement][word]);
    }

    // Update the convolver
    convolver.buffer = convolutionBuffers[currentMovement];

    // Play things!  in sequence for now...
    player.play(0, playback);
}

$(document).ready(function(){
    $("#textarea-input").val(startingText);

    // load things into remix
    var context = new webkitAudioContext();
    remixer = createJRemixer(context, $, apiKey);

    // Create the filter
    var filter = context.createBiquadFilter();
    filter.type = 0; // Low-pass filter. 
    filter.frequency.value = 1760; 

    // Load the convolver
    convolver = context.createConvolver();
    function finishedLoading(bufferList) {
        for (var convolveIndex = 0; convolveIndex < bufferList.length; convolveIndex++) {
            convolutionBuffers.push(bufferList[convolveIndex])
        }
        convolver.buffer = convolutionBuffers[currentMovement];
    }

    bufferLoader = new BufferLoader(context, convolutionURLs, finishedLoading);
    bufferLoader.load();

    // Add a gain to keep things backgrounded.
    var filterGain = context.createGainNode();
    filterGain.gain.value = 0.35;

    player = remixer.getPlayer();

    filteredPlayer = remixer.getPlayer([convolver, filter, filterGain]);
    info("Loading analysis data...");

    // Set up our segment arrays, for all movements
    for (var i = 0; i < organizedSegments.length; i++) {
        for (var j = 0; j < 12; j++ ) {
            organizedSegments[i][intsToNotes(j)] = [];
        }
    }

    // Set up the form charts

    // First movement form
    formWords[0] = {
        'introduction' = 0;
        'exposition' = 241;
        'development' = 513;
        'recap' = 635;
        'coda' = 774;
    }

    // Fourth movement form
    formWords[3] = {
        'exposition' = 0;
        'development' = 114;
        'recap' = 204;
        'coda' = 322;
    }     


    // Load the various files
    var remixedFlags = [true, false, false, false];
    var remixIndex = 0;
    function multipleRemix(tracks, trackIDs, trackURLs) {
        if (remixedFlags[remixIndex] = false) {
            // 10 second timer with recursive callback
            console.log('waiting on ' + remixIndex);
            setTimeout(multipleRemix(tracks, trackIDs, trackURLs), 10000);
        }
        else {
            // do a remix!
            remixer.remixTrackById(trackIDs[remixIndex], trackURLs[remixIndex], function(t, percent) {
                tracks[remixIndex] = t;

                info(percent + "% of the track loaded...");
                if (tracks[remixIndex].status == 'ok') {
                    // Organize each segment by max chroma
                    var chromaFloats = [];
                    for (var i = 0; i < tracks[remixIndex].analysis.segments.length; i++ ) {
                        chromaFloats = []
                        for (var j = 0; j < tracks[remixIndex].analysis.segments[i].pitches.length; j++) {
                            chromaFloats.push(parseFloat(tracks[remixIndex].analysis.segments[i].pitches[j]))
                        }
                        var maxVal = getMax(chromaFloats);
                        var note = intsToNotes(chromaFloats.indexOf(maxVal))
                        organizedSegments[remixIndex][note].push(tracks[remixIndex].analysis.segments[i]);
                    }
                    info('Ready!');
                    remixIndex = remixIndex + 1;
                    remixedFlags[remixIndex] = true;
                    multipleRemix(tracks, trackIDs, trackURLs);
                }
            });
        }
    }

    multipleRemix(tracks, trackIDs, trackURLs);


    // Take user input, update the UI, and parse the input
    $("#textarea-input").keyup(function(e) {
        if (e.which == 13) {
            var theString = $("#textarea-input").val();
            theString = trim(theString);

            var currentText = $('#text-log').html();
            var textArray = currentText.split('<br>');
            if (textArray.length > 10) {
                 textArray.shift();   
            }

            currentText = ''
            for (var i = 0; i < textArray.length; i++) {
                currentText = currentText + textArray[i] + '<br>';
            }

            var newHtml = currentText + theString
            $('#text-log').html(newHtml);
            $("#textarea-input").val("");

            parseInput(theString);
        }
      else if (e.which >= 65 && e.which  <= 76) {
          var theNote = String.fromCharCode(e.which).toLowerCase();
          switch(theNote) {
                  case 'h':
                    theNote = 'bb'
                    break;
                  case 'i':
                    theNote = 'eb'
                    break;
                  case 'j':
                    theNote = 'f#'
                    break;
                  case 'k':
                    theNote = 'c#'
                    break;
                  case 'l':
                    theNote = 'ab'
                    break;
                  default:
                    theNote = theNote;
                    break;
              }
          filteredPlayer.play(0, getRandomElement(organizedSegments[currentMovement][theNote]));
        }
    });
}); // end init

</script>

<div id="title">
     <h2>What We Talk About When We Talk About Beethoven</h2>
</div>

<div id="splash-image">
    <img src="splash.jpg">
</div>


<div id="text-log">
</div>

<div id="text-input">
    <textarea id="textarea-input" rows="7" cols="60">
    </textarea>
</div>

<div id="buttons">
</div>

<div id="about">
<p> What We Talk About When We Talk About Beethoven is a piece for human and human, or human and chatbot.</p>
<p> WWTAWWTAB works best in Chrome.</p>
</div>

<div id="info">
</div>

</body>

</html>